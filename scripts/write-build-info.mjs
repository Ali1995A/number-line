import { execSync } from "node:child_process";
import fs from "node:fs";
import path from "node:path";

function getSha() {
	const envSha =
		process.env.VERCEL_GIT_COMMIT_SHA ||
		process.env.GITHUB_SHA ||
		process.env.COMMIT_SHA ||
		process.env.SHA;
	if (envSha && typeof envSha === "string" && envSha.length >= 7) return envSha.slice(0, 7);
	try {
		return execSync("git rev-parse --short HEAD", { stdio: ["ignore", "pipe", "ignore"] })
			.toString()
			.trim();
	} catch {
		return "dev";
	}
}

function getVersion(repoRoot) {
	try {
		const pkgPath = path.join(repoRoot, "package.json");
		const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
		return typeof pkg.version === "string" ? pkg.version : "dev";
	} catch {
		return "dev";
	}
}

const repoRoot = process.cwd();
const sha = getSha();
const version = getVersion(repoRoot);

const outPath = path.join(repoRoot, "src", "build-info.ts");
const content =
	`// Auto-generated by scripts/write-build-info.mjs\n` +
	`export const BUILD_VERSION = ${JSON.stringify(version)};\n` +
	`export const BUILD_SHA = ${JSON.stringify(sha)};\n`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, content, "utf8");

